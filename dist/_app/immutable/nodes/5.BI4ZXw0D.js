import{f as g,a as d,c as V}from"../chunks/DqXKHUsY.js";import"../chunks/DybgDApQ.js";import{o as Ue,a as Le}from"../chunks/Cqkw32om.js";import{p as Re,t as S,o,g as e,m as Ee,w as Me,s as c,n as v,q as s,$ as Pe,v as n,x as De,y as W}from"../chunks/DmHJ9QOL.js";import{e as b,s as T}from"../chunks/CaJ6HOFi.js";import{i as $}from"../chunks/CcfVls_4.js";import{h as Ie,e as ae,b as Ne,s as se,i as Fe,t as Ge,f as Be}from"../chunks/CEQnzM2N.js";import{b as Ke,r as He,p as Oe}from"../chunks/Cl-7jzWS.js";import{i as je}from"../chunks/DPdeReKP.js";import{g as re}from"../chunks/BDw5y_s8.js";import{g as ze}from"../chunks/0u-JHG7E.js";var Je=g('<div class="audio-prompt svelte-11gxvh0"><p>Tap anywhere to enable pager sound alerts.</p></div>'),Qe=g("<option> </option>"),Ve=g('<p class="loading-state svelte-11gxvh0">Loading messages...</p>'),We=g('<p class="placeholder-state svelte-11gxvh0">Select a contact to start paging.</p>'),Xe=g('<p class="placeholder-state svelte-11gxvh0">No messages yet. Send a page!</p>'),Ye=g('<div><span class="message-content"> </span> <span class="timestamp svelte-11gxvh0"> </span></div>'),Ze=g('<p class="error-message svelte-11gxvh0"> </p>'),et=g('<main class="pager-container svelte-11gxvh0"><!> <div class="rhino-header svelte-11gxvh0"><span>ü¶è PAGER KING</span></div> <div class="header svelte-11gxvh0"><div class="user-info svelte-11gxvh0">Logged in as: <strong> </strong> <button class="logout-button svelte-11gxvh0">Logout</button></div></div> <div class="control-group svelte-11gxvh0"><label for="contact-select">Contact:</label> <select id="contact-select" class="svelte-11gxvh0"><option disabled>--- Select Contact ---</option><!></select></div> <div id="msgContainer"><!></div> <form class="send-form svelte-11gxvh0"><input type="text" placeholder="Type your page message..." required class="svelte-11gxvh0"/> <button type="submit" class="svelte-11gxvh0">Send Page</button></form> <!></main>');function ut(ie,oe){Re(oe,!1);const u=ze();let r=v(null),m=v([]),y=v([]),i=v(null),N=v("Select Contact"),p=v(""),w=v(!1),f=v(""),A,q=v(!1),F=v(!1),U=!1;Ue(async()=>{const{data:{user:t}}=await u.auth.getUser();if(s(r,t),!e(r)){re("/login");return}A=new Audio("/beep2.mp3"),A.loop=!0,new Audio().play().then(()=>U=!0).catch(()=>s(F,!0)),ne(),de()}),Le(()=>{u.removeAllChannels(),G()});async function ne(){if(!e(r))return;s(w,!0);const{data:t,error:a}=await u.from("users").select("id,email").not("id","eq",e(r).id).limit(10);a?(console.error(a),s(f,"Failed to load contacts")):t&&(s(m,t),e(m).length>0&&(s(i,e(m)[0].id),s(N,e(m)[0].email),X())),s(w,!1)}async function X(){if(!e(r)||!e(i)){s(y,[]);return}s(w,!0);const{data:t,error:a}=await u.from("messages").select("*").or(`and(sender_id.eq.${e(r).id},receiver_id.eq.${e(i)}),and(sender_id.eq.${e(i)},receiver_id.eq.${e(r).id})`).order("created_at",{ascending:!1}).limit(1);a?(console.error(a),s(f,"Failed to load messages")):s(y,t.reverse()),s(w,!1),B()}async function le(){if(!e(r)||!e(i)||e(p).trim()==="")return;const t=e(p).trim();s(p,""),s(f,"");const{data:a,error:l}=await u.from("messages").insert({sender_id:e(r).id,receiver_id:e(i),text:t}).select().single();if(l){console.error(l),s(f,"Failed to send message"),s(p,t);return}await u.from("messages").delete().or(`and(sender_id.eq.${e(r).id},receiver_id.eq.${e(i)}),and(sender_id.eq.${e(i)},receiver_id.eq.${e(r).id})`).not("id","eq",a.id),B()}function de(){u.channel("messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},t=>{const a=t.new;(a.sender_id===e(r)?.id&&a.receiver_id===e(i)||a.sender_id===e(i)&&a.receiver_id===e(r)?.id)&&s(y,[a]),a.receiver_id===e(r)?.id&&ce(a.text),B()}).subscribe()}function ce(t){e(q)||!U||(s(q,!0),A.play(),console.log(`PAGER ALERT: ${t}`))}function G(){e(q)&&(s(q,!1),A.pause(),A.currentTime=0)}function ve(){if(U)return;const t=new Audio;t.volume=0,t.play().then(()=>{U=!0,s(F,!1)}).catch(a=>console.error(a))}async function ue(t){await u.from("messages").update({read:!0}).eq("id",t),G()}function B(){setTimeout(()=>{const t=document.getElementById("msgContainer");t&&(t.scrollTop=t.scrollHeight)},50)}je();var L=et();Ie("11gxvh0",t=>{Me(()=>{Pe.title="Pager King ü¶è"})});var Y=o(L);{var ge=t=>{var a=Je();Ge(3,a,()=>Be,()=>({y:-50,duration:500})),d(t,a)};$(Y,t=>{e(F)&&t(ge)})}var K=c(Y,4),Z=o(K),H=c(o(Z)),me=o(H,!0);n(H);var pe=c(H,2);n(Z),n(K);var O=c(K,2),R=c(o(O),2);S(()=>{e(i),De(()=>{e(N),e(m),e(r)})});var j=o(R);j.value=(j.__value=null)??"";var fe=c(j);ae(fe,1,()=>e(m).filter(t=>t.id!==e(r)?.id),Fe,(t,a)=>{var l=Qe(),z=o(l,!0);n(l);var P={};S(()=>{T(z,e(a).email),P!==(P=e(a).id)&&(l.value=(l.__value=e(a).id)??"")}),d(t,l)}),n(R),n(O);var C=c(O,2);let ee;var _e=o(C);{var he=t=>{var a=Ve();d(t,a)},xe=t=>{var a=V(),l=W(a);{var z=_=>{var D=We();d(_,D)},P=_=>{var D=V(),Ae=W(D);{var qe=h=>{var I=Xe();d(h,I)},Ce=h=>{var I=V(),ke=W(I);ae(ke,1,()=>e(y),J=>J.id,(J,x)=>{var k=Ye(),Q=o(k),Se=o(Q,!0);n(Q);var te=c(Q,2),Te=o(te,!0);n(te),n(k),S($e=>{se(k,1,`message-entry ${e(x).sender_id===e(r)?.id?"out":"in"}`,"svelte-11gxvh0"),T(Se,e(x).text),T(Te,$e)},[()=>new Date(e(x).created_at).toLocaleTimeString()]),b("introend",k,()=>{e(x).receiver_id===e(r)?.id&&!e(x).read&&ue(e(x).id)}),d(J,k)}),d(h,I)};$(Ae,h=>{e(y).length===0?h(qe):h(Ce,!1)},!0)}d(_,D)};$(l,_=>{e(i)?_(P,!1):_(z)},!0)}d(t,a)};$(_e,t=>{e(w)?t(he):t(xe,!1)})}n(C);var E=c(C,2),M=o(E);He(M);var be=c(M,2);n(E);var ye=c(E,2);{var we=t=>{var a=Ze(),l=o(a,!0);n(a),S(()=>T(l,e(f))),d(t,a)};$(ye,t=>{e(f)&&t(we)})}n(L),S(t=>{T(me,e(r)?.email??"Unknown User"),ee=se(C,1,"msg-container svelte-11gxvh0",null,ee,{alerting:e(q)}),M.disabled=!e(i),be.disabled=t},[()=>!e(i)||e(p).trim()===""]),b("click",pe,async()=>{await u.auth.signOut(),re("/login")}),Ne(R,()=>e(i),t=>s(i,t)),b("change",R,()=>{s(N,e(m).find(t=>t.id===e(i))?.email||"Select Contact"),X()}),b("click",C,G),Ke(M,()=>e(p),t=>s(p,t)),b("submit",E,Oe(le)),b("click",L,ve),d(ie,L),Ee()}export{ut as component};
